# 配置迁移指南

## 从旧版本升级

如果您之前使用的是旧版本的 Print Proxy Service，本指南将帮助您迁移到新的配置系统。

## 主要变化

### 1. 环境变量重命名

旧版本使用 `PRINT_PROXY_*` 前缀，新版本使用更清晰的命名：

| 旧环境变量 | 新环境变量 | 说明 |
|-----------|-----------|------|
| `PRINT_PROXY_HOST` | `SERVER_HOST` | 服务器主机地址 |
| `PRINT_PROXY_PORT` | `SERVER_PORT` | 服务器端口 |
| `PRINT_PROXY_RELOAD` | `SERVER_RELOAD` | 自动重载开关 |

**向后兼容**：旧的环境变量仍然有效，但建议迁移到新命名。

### 2. 新增配置文件支持

新版本支持两种配置文件格式：

- **.env 文件**（推荐）：简单的键值对格式
- **config.yaml 文件**：结构化的 YAML 格式

### 3. 新增配置项

新版本添加了更多可配置项：

- 日志级别 (`LOG_LEVEL`)
- 最大文件大小 (`MAX_FILE_SIZE_MB`)
- Worker 进程数 (`SERVER_WORKERS`)
- 更多安全和数据库选项

## 迁移步骤

### 步骤 1：备份现有配置

如果您使用环境变量，记录当前的配置：

```powershell
# 查看当前环境变量
Get-ChildItem Env: | Where-Object { $_.Name -like "PRINT_PROXY_*" }
```

### 步骤 2：创建配置文件

#### 方式 A：使用 .env 文件（推荐）

```powershell
# 复制模板
copy .env.example .env

# 编辑 .env 文件
notepad .env
```

将您的旧配置迁移到 .env 文件：

```env
# 旧配置：
# $env:PRINT_PROXY_HOST = "0.0.0.0"
# $env:PRINT_PROXY_PORT = "8000"

# 新配置：
SERVER_HOST=0.0.0.0
SERVER_PORT=8000
```

#### 方式 B：使用 config.yaml 文件

```powershell
# 复制模板
copy config.yaml.example config.yaml

# 编辑 config.yaml 文件
notepad config.yaml
```

将您的旧配置迁移到 config.yaml：

```yaml
# 旧配置：
# $env:PRINT_PROXY_HOST = "0.0.0.0"
# $env:PRINT_PROXY_PORT = "8000"

# 新配置：
server:
  host: "0.0.0.0"
  port: 8000
```

### 步骤 3：更新启动脚本

#### 旧的启动方式

```powershell
# 设置环境变量
$env:PRINT_PROXY_HOST = "0.0.0.0"
$env:PRINT_PROXY_PORT = "8000"

# 启动服务
uvicorn app.main:app --reload
```

#### 新的启动方式

```powershell
# 方式 1：使用配置文件（推荐）
.\scripts\windows\start_server.ps1

# 方式 2：使用命令行参数
.\scripts\windows\start_server.ps1 -Host "0.0.0.0" -Port 8000

# 方式 3：查看当前配置
.\scripts\windows\start_server.ps1 -ShowConfig

# 方式 4：传统方式（仍然支持）
uvicorn app.main:app --reload
```

### 步骤 4：验证配置

启动服务后验证配置是否正确：

```powershell
# 查看配置
python scripts\show_config.py

# 测试服务
curl http://localhost:8568/docs
```

### 步骤 5：清理旧环境变量（可选）

如果您已经迁移到配置文件，可以清理旧的环境变量：

```powershell
# 临时清理（当前会话）
Remove-Item Env:\PRINT_PROXY_HOST
Remove-Item Env:\PRINT_PROXY_PORT
Remove-Item Env:\PRINT_PROXY_RELOAD

# 永久清理（系统环境变量）
# 在"系统属性 > 环境变量"中手动删除
```

## 配置示例

### 示例 1：从环境变量迁移到 .env

**旧配置（PowerShell）：**
```powershell
$env:PRINT_PROXY_HOST = "127.0.0.1"
$env:PRINT_PROXY_PORT = "9000"
$env:DATABASE_URL = "sqlite:///./my_database.db"
```

**新配置（.env 文件）：**
```env
SERVER_HOST=127.0.0.1
SERVER_PORT=9000
DATABASE_URL=sqlite:///./my_database.db
```

### 示例 2：从环境变量迁移到 config.yaml

**旧配置（PowerShell）：**
```powershell
$env:PRINT_PROXY_HOST = "0.0.0.0"
$env:PRINT_PROXY_PORT = "8568"
$env:JWT_SECRET_KEY = "my_secret_key"
```

**新配置（config.yaml）：**
```yaml
server:
  host: "0.0.0.0"
  port: 8568

security:
  jwt_secret_key: "my_secret_key"
```

## 常见问题

### Q1: 旧的环境变量还能用吗？

**A**: 可以！为了向后兼容，旧的 `PRINT_PROXY_*` 环境变量仍然有效。但建议迁移到新的命名以获得更好的一致性。

### Q2: 配置文件和环境变量哪个优先？

**A**: 优先级从高到低：
1. 环境变量（最高）
2. .env 文件
3. config.yaml 文件
4. 默认值（最低）

### Q3: 我可以同时使用 .env 和 config.yaml 吗？

**A**: 可以！它们会按优先级合并。.env 中的设置会覆盖 config.yaml 中的相同设置。

### Q4: 迁移后服务无法启动怎么办？

**A**: 检查步骤：
1. 运行 `python scripts\show_config.py` 查看配置是否正确加载
2. 检查配置文件语法是否正确
3. 查看日志文件：`%APPDATA%\PrintProxy\logs\`
4. 确认端口没有被占用：`netstat -ano | findstr :8568`

### Q5: 如何在 EXE 版本中使用配置文件？

**A**: 将 .env 或 config.yaml 文件放在 PrintProxy.exe 同目录下即可。

## 配置优化建议

### 开发环境

```env
SERVER_HOST=127.0.0.1
SERVER_PORT=8568
SERVER_RELOAD=true
LOG_LEVEL=DEBUG
DATABASE_ECHO=true
```

### 生产环境

```env
SERVER_HOST=0.0.0.0
SERVER_PORT=8568
SERVER_RELOAD=false
LOG_LEVEL=INFO
JWT_SECRET_KEY=使用强随机密钥
DATABASE_ECHO=false
MAX_FILE_SIZE_MB=100
```

### 测试环境

```env
SERVER_HOST=127.0.0.1
SERVER_PORT=8569
LOG_LEVEL=DEBUG
DATABASE_URL=sqlite:///./test_database.db
```

## 获取帮助

如果在迁移过程中遇到问题：

1. 查看完整配置文档：`docs\配置说明.md`
2. 运行配置检查：`python scripts\show_config.py`
3. 查看日志文件了解详细错误信息
4. 使用 `.\scripts\windows\start_server.ps1 -Help` 查看启动选项

## 回滚到旧版本

如果需要回滚到旧版本：

1. 删除新的配置文件：
   ```powershell
   Remove-Item .env -ErrorAction SilentlyContinue
   Remove-Item config.yaml -ErrorAction SilentlyContinue
   ```

2. 恢复旧的环境变量设置

3. 使用旧版本的启动命令

**注意**：新版本完全兼容旧的启动方式，通常不需要回滚。
