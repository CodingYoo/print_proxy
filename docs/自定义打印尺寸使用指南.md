# 自定义打印尺寸使用指南

## 功能概述

打印代理服务现已支持自定义打印尺寸和分辨率，特别适用于标签打印机、小票打印机等非标准纸张尺寸的场景。

## 支持的参数

### 1. `mediaSize` - 纸张尺寸

支持以下格式：

- **毫米格式**：`"40x60mm"` - 宽 40mm，高 60mm
- **英寸格式**：`"2x3inch"` - 宽 2 英寸，高 3 英寸
- **带 DPI 格式**：`"40x60mm@300dpi"` - 指定分辨率
- **小数支持**：`"40.5x60.5mm"` - 支持小数尺寸

### 2. `dpi` - 分辨率（可选）

- 默认值：`203` DPI（标签打印机常用分辨率）
- 取值范围：72 - 1200 DPI
- 如果在 `mediaSize` 中指定了 `@XXXdpi`，则优先使用该值

### 3. `colorMode` - 颜色模式

- `"color"` - 彩色打印（默认）
- `"monochrome"` / `"mono"` / `"bw"` - 黑白打印
- `"grayscale"` / `"gray"` - 灰度打印

### 4. `fitMode` - 填充模式（新增）

- `"fill"` - **填满纸张**（默认，推荐用于标签打印）- 图片会缩放到完全填满纸张，保持宽高比
- `"contain"` - 完整显示图片 - 图片完整显示，可能有留白
- `"cover"` - 覆盖纸张 - 填满纸张，可能裁剪部分内容
- `"stretch"` - 拉伸填充 - 强制填满，可能变形

### 5. `autoRotate` - 自动旋转（新增）

- `true` - **自动旋转**（默认）- 当图片方向与纸张不匹配时，自动旋转 90 度以最佳适配
- `false` - 不旋转 - 保持原始方向

### 6. `enhanceQuality` - 质量增强（新增，强烈推荐）

- `true` - **启用质量增强**（默认）- 自动优化打印清晰度
  - 🔍 **锐化处理**：增强边缘清晰度，文字和二维码更清晰
  - 📊 **对比度优化**：黑白打印增强 20% 对比度，彩色打印增强 10%
  - 🎨 **智能抖动**：黑白打印使用 Floyd-Steinberg 抖动算法，效果更细腻
  - 🖼️ **高质量缩放**：使用 LANCZOS 算法，避免锯齿和模糊
- `false` - 不增强 - 使用原始图片质量

### 7. `duplex` - 双面打印

- `"none"` - 单面打印（默认）
- `"long-edge"` - 长边翻转
- `"short-edge"` - 短边翻转

## 使用示例

### Java 客户端示例

```java
// 标签打印机 - 40mm × 60mm @ 203dpi（高清晰度配置）
PrintJobRequest request = PrintJobRequest.builder()
    .title("子瓶标签 - " + batchNumber)
    .printerName(printerName != null ? printerName : defaultPrinterName)
    .fileType("png")
    .contentBase64(qrCodeBase64)
    .copies(1)
    .priority(5)
    .mediaSize("40x60mm")           // 标签纸张尺寸：40mm × 60mm
    .colorMode("monochrome")         // 黑白打印
    .fitMode("fill")                 // 填满纸张（默认）
    .autoRotate(true)                // 自动旋转以适配纸张（默认）
    .enhanceQuality(true)            // 启用质量增强（默认，强烈推荐）
    .duplex("none")                  // 单面打印
    .businessType("SUB_FLASK")
    .batchNumber(batchNumber)
    .build();
```

### Python 客户端示例

```python
import requests
import base64

# 读取图片并转换为 Base64
with open("label.png", "rb") as f:
    image_base64 = base64.b64encode(f.read()).decode()

# 创建打印任务
response = requests.post(
    "http://localhost:8568/api/jobs/",
    headers={"Authorization": f"Bearer {token}"},
    json={
        "title": "标签打印",
        "printer_name": "Label Printer",
        "file_type": "png",
        "content_base64": image_base64,
        "copies": 1,
        "priority": 5,
        "media_size": "40x60mm",      # 或 "40x60mm@203dpi"
        "color_mode": "monochrome",
        "fit_mode": "fill",           # 填满纸张
        "auto_rotate": True,          # 自动旋转
        "enhance_quality": True,      # 质量增强（推荐）
        "duplex": "none"
    }
)
```

### cURL 示例

```bash
curl -X POST "http://localhost:8568/api/jobs/" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "标签打印",
    "printer_name": "Label Printer",
    "file_type": "png",
    "content_base64": "iVBORw0KGgoAAAANS...",
    "copies": 1,
    "priority": 5,
    "media_size": "40x60mm",
    "color_mode": "monochrome",
    "duplex": "none"
  }'
```

## 常见打印机尺寸配置

### 标签打印机

| 打印机类型 | 尺寸配置 | DPI | 说明 |
|-----------|---------|-----|------|
| 小型标签 | `"40x60mm"` | 203 | 常用于产品标签 |
| 中型标签 | `"50x80mm"` | 203 | 常用于物流标签 |
| 大型标签 | `"100x150mm"` | 300 | 常用于快递单 |
| 珠宝标签 | `"30x20mm"` | 203 | 小尺寸标签 |

### 小票打印机

| 打印机类型 | 尺寸配置 | DPI | 说明 |
|-----------|---------|-----|------|
| 58mm 小票 | `"58x297mm"` | 203 | 标准小票宽度 |
| 80mm 小票 | `"80x297mm"` | 203 | 常用小票宽度 |

### 标准纸张（参考）

| 纸张类型 | 尺寸配置 | 说明 |
|---------|---------|------|
| A4 | `"210x297mm"` | 标准 A4 纸 |
| Letter | `"8.5x11inch"` | 美国标准信纸 |

## 工作原理

### 1. 尺寸解析

系统会自动解析 `mediaSize` 参数：

```
"40x60mm@203dpi" 
  ↓
宽度：40mm ÷ 25.4 × 203 ≈ 319 像素
高度：60mm ÷ 25.4 × 203 ≈ 479 像素
```

### 2. 自动旋转（新功能）

当 `autoRotate=true` 时，系统会智能判断是否需要旋转：

```
场景 1：横向图片 + 纵向纸张
  图片：800×600 (横向)
  纸张：319×479 (纵向)
  → 自动旋转 90 度 → 600×800 (纵向)

场景 2：纵向图片 + 横向纸张  
  图片：600×800 (纵向)
  纸张：479×319 (横向)
  → 自动旋转 90 度 → 800×600 (横向)
```

### 3. 图片缩放与填充

根据 `fitMode` 参数：

- **fill 模式**（推荐）：缩放到完全填满纸张
  - 保持宽高比
  - 如果超出纸张，居中裁剪
  - 无留白，充分利用纸张

- **contain 模式**：完整显示图片
  - 保持宽高比
  - 可能有留白
  - 适合需要完整显示内容的场景

### 4. 质量增强处理（新功能）

当 `enhanceQuality=true` 时，系统会自动优化图片：

**黑白打印优化**：
```
原始图片
  ↓ 对比度增强 +20%
  ↓ 锐化处理（SHARPEN 滤镜）
  ↓ Floyd-Steinberg 抖动算法
  ↓ 高质量 LANCZOS 缩放
最终打印图片（清晰度显著提升）
```

**彩色/灰度打印优化**：
```
原始图片
  ↓ 对比度增强 +10%
  ↓ 锐化处理
  ↓ 高质量 LANCZOS 缩放
最终打印图片
```

**效果对比**：
- ✅ 二维码边缘更锐利，扫描成功率更高
- ✅ 文字更清晰，小字号也能看清
- ✅ 黑白过渡更自然（抖动算法）
- ✅ 无锯齿、无模糊

### 5. 颜色转换

根据 `colorMode` 自动转换图片：
- `monochrome`：使用 Floyd-Steinberg 抖动算法转换为纯黑白（1-bit）
- `grayscale`：转换为灰度（8-bit）
- `color`：保持 RGB 彩色

## 最佳实践

### 1. 图片准备建议

- **分辨率匹配**：准备图片时，尽量使用目标 DPI
  - 40×60mm @ 203dpi = 319×479 像素
  - 40×60mm @ 300dpi = 472×709 像素

- **宽高比一致**：图片宽高比应与纸张尺寸一致，避免留白过多

- **质量增强已内置**：
  - ✅ 无需手动锐化或调整对比度
  - ✅ 系统会自动优化（`enhanceQuality=true`）
  - ✅ 直接上传原始图片即可获得最佳效果

### 2. 性能优化

- **避免过大图片**：不要上传超大分辨率图片，系统会自动缩放
- **批量打印**：使用 `copies` 参数而不是多次调用 API

### 3. 错误处理

```python
try:
    response = requests.post(url, json=data)
    response.raise_for_status()
    job = response.json()
    print(f"打印任务创建成功，ID: {job['id']}")
except requests.exceptions.HTTPError as e:
    print(f"打印失败: {e.response.json()['detail']}")
```

## 故障排查

### 问题 1：打印尺寸不正确

**可能原因**：
- `mediaSize` 格式错误
- 打印机驱动未正确识别自定义尺寸

**解决方案**：
1. 检查 `mediaSize` 格式是否正确（如 `"40x60mm"`）
2. 在打印机驱动中预先配置自定义纸张尺寸
3. 查看日志确认解析的像素尺寸

### 问题 2：图片被裁剪或变形

**可能原因**：
- 图片宽高比与纸张不匹配
- 图片分辨率过低

**解决方案**：
1. 调整图片宽高比与纸张一致
2. 提高图片分辨率
3. 检查日志中的缩放信息

### 问题 3：黑白打印效果不佳

**可能原因**：
- 原图对比度不足
- 使用了 `grayscale` 而非 `monochrome`

**解决方案**：
1. 使用 `"colorMode": "monochrome"` 强制黑白
2. 提前处理图片，增强对比度
3. 使用抖动算法预处理图片

## 日志查看

打印任务会记录详细的尺寸信息：

```
使用自定义打印尺寸: 319x479 像素 (来自 40x60mm@203dpi)
```

查看日志位置：
- Windows: `%APPDATA%\PrintProxy\logs\`
- 日志文件：`printproxy_YYYYMMDD.log`

## API 响应示例

```json
{
  "id": 123,
  "title": "子瓶标签 - BATCH001",
  "status": "queued",
  "file_type": "png",
  "copies": 1,
  "priority": 5,
  "media_size": "40x60mm@203dpi",
  "color_mode": "monochrome",
  "duplex": "none",
  "printer_name": "Label Printer",
  "created_at": "2025-10-24T10:30:00",
  "updated_at": "2025-10-24T10:30:00",
  "error_message": null
}
```

## 技术支持

如有问题，请查看：
1. 日志文件：`%APPDATA%\PrintProxy\logs\`
2. API 文档：`http://localhost:8568/docs`
3. 测试接口：使用 Swagger UI 进行调试
