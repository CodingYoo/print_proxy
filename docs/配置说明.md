# Print Proxy Service 配置说明

## 配置方式

Print Proxy Service 支持多种配置方式，按优先级从高到低排列：

1. **环境变量** - 最高优先级
2. **.env 文件** - 中等优先级
3. **config.yaml 文件** - 较低优先级
4. **默认值** - 最低优先级

## 配置文件

### 方式 1：使用 .env 文件（推荐）

复制 `.env.example` 为 `.env` 并修改配置：

```bash
copy .env.example .env
```

然后编辑 `.env` 文件：

```env
# 服务器配置
SERVER_HOST=0.0.0.0
SERVER_PORT=8568

# 安全配置
JWT_SECRET_KEY=your_secret_key_here

# 日志级别
LOG_LEVEL=INFO
```

### 方式 2：使用 config.yaml 文件

复制 `config.yaml.example` 为 `config.yaml` 并修改配置：

```bash
copy config.yaml.example config.yaml
```

然后编辑 `config.yaml` 文件：

```yaml
server:
  host: "0.0.0.0"
  port: 8568

security:
  jwt_secret_key: "your_secret_key_here"

logging:
  level: "INFO"
```

### 方式 3：使用环境变量

在 Windows PowerShell 中：

```powershell
$env:SERVER_HOST = "127.0.0.1"
$env:SERVER_PORT = "9000"
$env:LOG_LEVEL = "DEBUG"
```

在 Windows CMD 中：

```cmd
set SERVER_HOST=127.0.0.1
set SERVER_PORT=9000
set LOG_LEVEL=DEBUG
```

## 主要配置项

### 应用程序设置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 应用名称 | `APP_NAME` | `Print Proxy Service` | 应用程序显示名称 |
| API 前缀 | `API_PREFIX` | `/api` | API 路由前缀 |

### 服务器设置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 主机地址 | `SERVER_HOST` | `0.0.0.0` | 服务器监听地址<br>- `0.0.0.0`: 所有网络接口<br>- `127.0.0.1`: 仅本地访问 |
| 端口 | `SERVER_PORT` | `8568` | 服务器监听端口 |
| 自动重载 | `SERVER_RELOAD` | `false` | 开发模式自动重载 |
| 工作进程数 | `SERVER_WORKERS` | `1` | Worker 进程数量 |

### 数据库设置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 数据库 URL | `DATABASE_URL` | SQLite (用户目录) | 数据库连接字符串 |
| 查询日志 | `DATABASE_ECHO` | `false` | 是否记录 SQL 查询 |

### 安全设置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| Token 过期时间 | `ACCESS_TOKEN_EXPIRE_MINUTES` | `10080` (7天) | JWT Token 有效期（分钟） |
| JWT 算法 | `JWT_ALGORITHM` | `HS256` | JWT 加密算法 |
| JWT 密钥 | `JWT_SECRET_KEY` | `change_me` | JWT 签名密钥（生产环境必须修改） |

### 文件和预览设置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 允许预览格式 | `ALLOWED_PREVIEW_FORMATS` | `pdf,png,jpg,jpeg` | 支持预览的文件格式 |
| 最大文件大小 | `MAX_FILE_SIZE_MB` | `50` | 上传文件大小限制（MB） |

### 日志设置

| 配置项 | 环境变量 | 默认值 | 说明 |
|--------|----------|--------|------|
| 日志目录 | `LOG_DIRECTORY` | 用户 AppData 目录 | 日志文件存储位置 |
| 日志级别 | `LOG_LEVEL` | `INFO` | 日志级别：DEBUG, INFO, WARNING, ERROR, CRITICAL |

## 向后兼容

为了保持向后兼容，以下旧版环境变量仍然支持：

| 旧环境变量 | 新环境变量 | 说明 |
|-----------|-----------|------|
| `PRINT_PROXY_HOST` | `SERVER_HOST` | 服务器主机地址 |
| `PRINT_PROXY_PORT` | `SERVER_PORT` | 服务器端口 |
| `PRINT_PROXY_RELOAD` | `SERVER_RELOAD` | 自动重载开关 |

**注意**：如果同时设置了新旧环境变量，新环境变量优先。

## 常见配置场景

### 场景 1：仅本地访问

```env
SERVER_HOST=127.0.0.1
SERVER_PORT=8568
```

### 场景 2：局域网访问

```env
SERVER_HOST=0.0.0.0
SERVER_PORT=8568
```

### 场景 3：自定义端口（避免冲突）

```env
SERVER_HOST=0.0.0.0
SERVER_PORT=9000
```

### 场景 4：开发调试模式

```env
SERVER_HOST=127.0.0.1
SERVER_PORT=8568
SERVER_RELOAD=true
LOG_LEVEL=DEBUG
DATABASE_ECHO=true
```

### 场景 5：生产环境

```env
SERVER_HOST=0.0.0.0
SERVER_PORT=8568
SERVER_RELOAD=false
LOG_LEVEL=INFO
JWT_SECRET_KEY=your_very_secure_random_key_here
DATABASE_ECHO=false
```

## 配置文件位置

### 开发环境

配置文件应放在项目根目录：

```
print_proxy/
├── .env                    # 环境变量配置
├── config.yaml             # YAML 配置
├── app/
└── ...
```

### 生产环境（EXE 打包后）

配置文件应放在 EXE 文件同目录：

```
C:\Program Files\PrintProxy\
├── PrintProxy.exe
├── .env                    # 可选
└── config.yaml             # 可选
```

或者使用系统环境变量（推荐）。

## 数据和日志位置

无论配置文件在哪里，数据库和日志默认存储在用户目录：

- **Windows**: `%APPDATA%\PrintProxy\`
  - 数据库: `%APPDATA%\PrintProxy\print_proxy.db`
  - 日志: `%APPDATA%\PrintProxy\logs\`

这样可以避免权限问题，即使程序安装在 `Program Files` 也能正常运行。

## 验证配置

启动服务后，可以通过以下方式验证配置：

1. 查看日志文件：`%APPDATA%\PrintProxy\logs\printproxy_YYYYMMDD.log`
2. 访问 API 文档：`http://localhost:8568/docs`（根据配置的端口）
3. 检查进程监听端口：
   ```powershell
   netstat -ano | findstr :8568
   ```

## 安全建议

1. **生产环境必须修改 JWT_SECRET_KEY**
   ```env
   JWT_SECRET_KEY=使用随机生成的长字符串
   ```

2. **限制网络访问**
   - 如果只需本地访问，设置 `SERVER_HOST=127.0.0.1`
   - 如果需要局域网访问，配置防火墙规则

3. **使用 HTTPS**
   - 在生产环境中，建议在前面加一层反向代理（如 Nginx）提供 HTTPS

4. **定期更新密钥**
   - 定期更换 JWT_SECRET_KEY
   - 更换后所有现有 Token 将失效，用户需要重新登录

## 故障排查

### 端口被占用

```powershell
# 查看端口占用
netstat -ano | findstr :8568

# 修改端口
$env:SERVER_PORT = "9000"
```

### 配置不生效

检查配置优先级：
1. 确认环境变量是否覆盖了配置文件
2. 检查 .env 文件是否在正确位置
3. 查看日志文件确认实际使用的配置

### 权限问题

如果遇到权限错误：
1. 确认日志和数据库目录有写入权限
2. 不要将配置文件放在需要管理员权限的目录
3. 使用默认的用户 AppData 目录存储数据
