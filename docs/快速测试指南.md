# PrintProxy 快速测试指南

## ✅ 已完成修复

### 修复的问题
- ❌ 旧版：数据库和日志写入 `C:\Program Files\PrintProxy\`（无权限）
- ✅ 新版：数据库和日志写入 `%APPDATA%\PrintProxy\`（有权限）

### 修改的文件
1. **app/core/config.py** - 数据库和日志路径改为用户目录
2. **scripts/windows/run_app.py** - 所有日志路径改为用户目录
3. **dist/PrintProxy.exe** - 已重新构建（53.8 MB）
4. **scripts/windows/PrintProxySetup_1.0.0.exe** - 已重新构建（51.3 MB）

---

## 🧪 测试步骤

### 步骤 1：卸载旧版本（如果已安装）

```powershell
# 打开 PowerShell（无需管理员权限）

# 方法 1：控制面板卸载
控制面板 → 程序和功能 → 找到 "Print Proxy" → 卸载

# 或方法 2：手动删除注册表（如果卸载失败）
Remove-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Print Proxy" -ErrorAction SilentlyContinue

# 停止运行的进程
Stop-Process -Name PrintProxy -Force -ErrorAction SilentlyContinue

# 删除旧的数据文件
Remove-Item -Path "$env:APPDATA\PrintProxy" -Recurse -Force -ErrorAction SilentlyContinue
```

### 步骤 2：安装新版本

```powershell
# 以管理员身份运行安装器
右键 scripts\windows\PrintProxySetup_1.0.0.exe
→ 选择"以管理员身份运行"
→ 点击 "Next" → 选择安装目录 → 点击 "Install"
→ 安装完成后，选择 "Yes" 立即启动程序
```

**注意：** 安装时需要管理员权限，但运行时以普通用户权限运行。

### 步骤 3：验证安装

```powershell
# 1. 检查安装目录（只读文件）
dir "C:\Program Files\PrintProxy\"

# 预期输出：
# PrintProxy.exe
# app\templates\

# 2. 检查用户数据目录（可写文件）
dir "$env:APPDATA\PrintProxy"

# 预期输出：
# print_proxy.db
# logs\

# 3. 检查注册表
Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Print Proxy"

# 预期输出：
# Print Proxy : "C:\Program Files\PrintProxy\PrintProxy.exe"
```

### 步骤 4：检查进程和服务

```powershell
# 检查进程是否运行
tasklist | findstr PrintProxy

# 预期输出：
# PrintProxy.exe                 12345 Console                    1    120,000 K

# 检查端口监听
netstat -ano | findstr :8568

# 预期输出：
# TCP    0.0.0.0:8568           0.0.0.0:0              LISTENING       12345

# 测试 HTTP 服务
curl http://localhost:8568/docs

# 预期输出：
# 返回 HTML 页面（Swagger UI）
```

### 步骤 5：检查日志文件

```powershell
# 查看日志（最关键的验证步骤！）
Get-Content "$env:APPDATA\PrintProxy\logs\printproxy_*.log" -Tail 30

# 预期输出应该包含（无权限错误）：
# ==========================================
# PrintProxy starting...
# Python: 3.11.13
# Working directory: C:\Program Files\PrintProxy
# Executable: C:\Program Files\PrintProxy\PrintProxy.exe
# Frozen: True
# Starting server on 0.0.0.0:8568
# Application startup complete

# 检查是否有权限错误
Get-Content "$env:APPDATA\PrintProxy\logs\printproxy_*.log" | Select-String "Permission denied"

# 预期输出：
# （无输出，表示没有权限错误）✅

# 检查数据库路径
Get-Content "$env:APPDATA\PrintProxy\logs\printproxy_*.log" | Select-String "database"

# 应该能看到数据库位置在用户目录
```

### 步骤 6：检查数据库

```powershell
# 验证数据库文件存在
Test-Path "$env:APPDATA\PrintProxy\print_proxy.db"

# 预期输出：True

# 检查数据库大小
(Get-Item "$env:APPDATA\PrintProxy\print_proxy.db").Length

# 预期输出：几 KB 到几十 KB（非零）
```

### 步骤 7：访问 Web 界面

```powershell
# 方法 1：使用浏览器
打开浏览器，访问：http://localhost:8568

# 方法 2：使用 PowerShell
Start-Process "http://localhost:8568"

# 预期结果：
# - 看到登录页面或主页
# - 无 404 或 500 错误
```

### 步骤 8：重启电脑测试（最重要！）

```powershell
# 1. 重启电脑
Restart-Computer

# 2. 登录后等待 10-15 秒

# 3. 验证自启动
tasklist | findstr PrintProxy

# 预期输出：
# PrintProxy.exe                 XXXX Console                    1    XXX,XXX K

# 4. 验证服务
curl http://localhost:8568/docs

# 预期输出：
# 返回 HTML 页面（Swagger UI）

# 5. 查看今天的日志
Get-Content "$env:APPDATA\PrintProxy\logs\printproxy_$(Get-Date -Format 'yyyyMMdd').log" -Tail 20

# 预期输出：
# 今天的启动日志，无权限错误 ✅

# 6. 检查进程用户
Get-Process PrintProxy | ForEach-Object {
    $owner = (Get-WmiObject Win32_Process -Filter "ProcessId=$($_.Id)").GetOwner()
    Write-Host "运行用户: $($owner.Domain)\$($owner.User)"
}

# 预期输出：
# 运行用户: [您的计算机名]\[您的用户名] ✅
```

---

## ✅ 成功标志

### 安装成功
- [x] 安装器运行完成，无错误
- [x] Program Files 目录包含 PrintProxy.exe
- [x] 用户数据目录自动创建
- [x] HKCU 注册表包含自启动项

### 运行成功
- [x] 进程 PrintProxy.exe 正常运行
- [x] 端口 8568 正常监听
- [x] HTTP 服务正常响应
- [x] 日志文件在 `%APPDATA%\PrintProxy\logs\`
- [x] 数据库文件在 `%APPDATA%\PrintProxy\print_proxy.db`
- [x] **日志中无 "Permission denied" 错误** ← 最关键

### 重启成功
- [x] 重启后程序自动启动
- [x] 以当前用户权限运行（非管理员）
- [x] 服务正常响应
- [x] 日志正常写入，无权限错误

---

## 🚨 故障排查

### 问题 1：安装后日志仍在 Program Files

**症状：**
```powershell
Test-Path "C:\Program Files\PrintProxy\logs\"
# 返回 True（错误！）
```

**原因：** 使用了旧版本的 EXE

**解决方案：**
```powershell
# 1. 完全卸载
控制面板 → 卸载 Print Proxy

# 2. 删除残留文件
Remove-Item "C:\Program Files\PrintProxy" -Recurse -Force

# 3. 确认使用新构建的 EXE
# 检查 EXE 构建时间
(Get-Item "C:\Users\CodingYooo\Desktop\print_proxy\dist\PrintProxy.exe").LastWriteTime

# 应该是最近时间（今天）

# 4. 重新运行构建脚本
powershell -ExecutionPolicy Bypass -File "C:\Users\CodingYooo\Desktop\print_proxy\scripts\windows\build_exe.ps1"
powershell -ExecutionPolicy Bypass -File "C:\Users\CodingYooo\Desktop\print_proxy\scripts\windows\build_installer.ps1"

# 5. 重新安装
```

### 问题 2：重启后没有自启动

**检查注册表：**
```powershell
Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Print Proxy"

# 如果返回空或错误，手动添加：
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run" -Name "Print Proxy" -Value '"C:\Program Files\PrintProxy\PrintProxy.exe"'
```

### 问题 3：端口被占用

**检查端口：**
```powershell
netstat -ano | findstr :8568

# 如果已被占用，修改端口：
[System.Environment]::SetEnvironmentVariable("PRINT_PROXY_PORT", "9000", "User")

# 重启程序
Stop-Process -Name PrintProxy -Force
& "C:\Program Files\PrintProxy\PrintProxy.exe"
```

### 问题 4：日志中仍有权限错误

**查看完整错误：**
```powershell
Get-Content "$env:APPDATA\PrintProxy\logs\printproxy_*.log" | Select-String "Permission" -Context 3,3
Get-Content "$env:APPDATA\PrintProxy\logs\error.log"

# 如果错误涉及数据库，检查数据库位置：
Get-Content "$env:APPDATA\PrintProxy\logs\printproxy_*.log" | Select-String "database\|sqlite"
```

**可能原因：**
1. EXE 未使用新代码 → 重新构建
2. 环境变量 DATABASE_URL 设置错误 → 删除环境变量
3. 旧的配置文件残留 → 清理用户目录重新安装

---

## 📊 验证清单

### 快速验证（5 分钟）

```powershell
# 一键检查脚本
powershell -ExecutionPolicy Bypass -Command "
Write-Host '=== PrintProxy 快速验证 ===' -ForegroundColor Cyan
Write-Host ''

# 1. 检查进程
Write-Host '[1/6] 进程检查...' -NoNewline
if (Get-Process PrintProxy -ErrorAction SilentlyContinue) {
    Write-Host ' [OK]' -ForegroundColor Green
} else {
    Write-Host ' [失败] 进程未运行' -ForegroundColor Red
}

# 2. 检查端口
Write-Host '[2/6] 端口检查...' -NoNewline
if (netstat -ano | findstr ':8568.*LISTENING') {
    Write-Host ' [OK]' -ForegroundColor Green
} else {
    Write-Host ' [失败] 端口未监听' -ForegroundColor Red
}

# 3. 检查用户数据目录
Write-Host '[3/6] 用户数据目录...' -NoNewline
if (Test-Path `$env:APPDATA\PrintProxy) {
    Write-Host ' [OK]' -ForegroundColor Green
} else {
    Write-Host ' [失败] 目录不存在' -ForegroundColor Red
}

# 4. 检查数据库
Write-Host '[4/6] 数据库文件...' -NoNewline
if (Test-Path `$env:APPDATA\PrintProxy\print_proxy.db) {
    Write-Host ' [OK]' -ForegroundColor Green
} else {
    Write-Host ' [失败] 数据库不存在' -ForegroundColor Red
}

# 5. 检查日志
Write-Host '[5/6] 日志文件...' -NoNewline
if (Test-Path `$env:APPDATA\PrintProxy\logs\printproxy_*.log) {
    Write-Host ' [OK]' -ForegroundColor Green
} else {
    Write-Host ' [失败] 日志不存在' -ForegroundColor Red
}

# 6. 检查权限错误
Write-Host '[6/6] 权限错误检查...' -NoNewline
`$errors = Get-Content `$env:APPDATA\PrintProxy\logs\printproxy_*.log -ErrorAction SilentlyContinue | Select-String 'Permission denied'
if (`$errors) {
    Write-Host ' [失败] 发现权限错误' -ForegroundColor Red
    `$errors | ForEach-Object { Write-Host `$_ -ForegroundColor Yellow }
} else {
    Write-Host ' [OK] 无权限错误' -ForegroundColor Green
}

Write-Host ''
Write-Host '=== 验证完成 ===' -ForegroundColor Cyan
"
```

---

## 🎯 预期结果总结

| 检查项 | 预期结果 | 说明 |
|--------|---------|------|
| 安装目录 | `C:\Program Files\PrintProxy\` | 仅包含 EXE 和 templates |
| 数据目录 | `%APPDATA%\PrintProxy\` | 包含数据库和日志 |
| 数据库位置 | `%APPDATA%\PrintProxy\print_proxy.db` | ✅ 用户可写 |
| 日志位置 | `%APPDATA%\PrintProxy\logs\` | ✅ 用户可写 |
| 注册表 | HKCU\...\Run\Print Proxy | ✅ 用户级自启动 |
| 进程用户 | 当前登录用户 | ✅ 非管理员 |
| 权限错误 | 无 | ✅ 最关键 |
| HTTP 服务 | http://localhost:8568 | ✅ 正常响应 |

---

## 📞 技术支持命令

```powershell
# 收集诊断信息
powershell -ExecutionPolicy Bypass -Command "
Write-Host '=== PrintProxy 诊断信息 ===' -ForegroundColor Cyan
Write-Host ''

Write-Host '--- 进程信息 ---'
Get-Process PrintProxy -ErrorAction SilentlyContinue | Select-Object Id, ProcessName, StartTime, WorkingSet

Write-Host ''
Write-Host '--- 端口信息 ---'
netstat -ano | findstr :8568

Write-Host ''
Write-Host '--- 文件位置 ---'
Write-Host 'EXE:' (Get-Item 'C:\Program Files\PrintProxy\PrintProxy.exe' -ErrorAction SilentlyContinue).FullName
Write-Host 'DB:' (Get-Item `$env:APPDATA\PrintProxy\print_proxy.db -ErrorAction SilentlyContinue).FullName
Write-Host 'Logs:' (Get-Item `$env:APPDATA\PrintProxy\logs -ErrorAction SilentlyContinue).FullName

Write-Host ''
Write-Host '--- 注册表 ---'
(Get-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Run' -Name 'Print Proxy' -ErrorAction SilentlyContinue).'Print Proxy'

Write-Host ''
Write-Host '--- 最近日志 (最后10行) ---'
Get-Content `$env:APPDATA\PrintProxy\logs\printproxy_*.log -Tail 10 -ErrorAction SilentlyContinue

Write-Host ''
Write-Host '--- 权限错误 ---'
Get-Content `$env:APPDATA\PrintProxy\logs\printproxy_*.log -ErrorAction SilentlyContinue | Select-String 'Permission'

Write-Host ''
Write-Host '=== 诊断完成 ===' -ForegroundColor Cyan
"
```

---

**版本：** 1.0.1  
**测试日期：** 待测试  
**预期结果：** ✅ 重启后自动启动，无权限错误
